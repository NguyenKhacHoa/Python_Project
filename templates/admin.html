<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Code Reviewer</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Link CSS Chung (Layout, Sidebar) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <!-- Link CSS Ri√™ng cho Admin -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <div class="app-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="brand">
                <div class="logo-icon"><i class="fa-brands fa-connectdevelop"></i></div>
                <span>Code Reviewer</span>
            </div>

            <nav class="nav-menu">
                <div class="menu-label">MENU</div>
                <a href="{{ url_for('home') }}" class="nav-item">
                    <i class="fa-solid fa-code"></i>Ph√¢n T√≠ch Code
                </a>
                <a href="{{ url_for('admin_dashboard') }}" class="nav-item active">
                    <i class="fa-solid fa-users-gear"></i>Qu·∫£n L√Ω Users
                </a>
                <a href="{{ url_for('history_page') }}" class="nav-item">
                    <i class="fa-solid fa-clock-rotate-left"></i>L·ªãch S·ª≠ Review
                </a>
                <a href="{{ url_for('settings') }}" class="nav-item">
                    <i class="fa-solid fa-gear"></i>C√†i ƒê·∫∑t
                </a>
            </nav>

            <div class="user-panel">
                <div class="avatar">{{ username[0]|upper }}</div>
                <div class="info">
                    <strong>{{ username }}</strong>
                    <span>{{ role|upper }}</span>
                </div>
                <a href="{{ url_for('logout') }}" class="btn-logout" title="ƒêƒÉng xu·∫•t">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- Header & Search -->
            <header class="admin-header">
                <div>
                    <h2>Qu·∫£n tr·ªã h·ªá th·ªëng üõ°Ô∏è</h2>
                    <p class="text">T·ªïng quan ho·∫°t ƒë·ªông v√† qu·∫£n l√Ω th√†nh vi√™n.</p>
                </div>

                <!-- Thanh t√¨m ki·∫øm -->
                <form action="{{ url_for('admin_dashboard') }}" method="GET" class="search-box">
                    <input type="text" name="q" placeholder="T√¨m t√™n ho·∫∑c email..." value="{{ search_query or '' }}" autocomplete="off">
                    <button type="submit" title="T√¨m ki·∫øm"><i class="fa-solid fa-magnifying-glass"></i></button>
                </form>
            </header>

            <!-- Stats Cards -->
            <div class="stat-container">
                <div class="stat-card">
                   <div class="icon-box purple"><i class="fa-solid fa-users"></i></div>
                    <div class="stat-info">
                        <h3>{{ stats.total_users }}</h3>
                        <span>Th√†nh vi√™n</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="icon-box green"><i class="fa-solid fa-file-code"></i></div>
                    <div class="stat-info">
                        <h3>{{ stats.total_reviews }}</h3>
                        <span>L∆∞·ª£t Review</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="icon-box red"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="stat-info">
                        <h3>{{ stats.high_risk }}</h3>
                        <span>Review r·ªßi ro</span>
                    </div>
                </div>
            </div>

            <!-- User List Panel -->
            <div class="panel">
                <div class="panel-head">
                    <span class="panel-title">
                        <i class="fa-solid fa-users-rectangle"></i> Danh S√°ch T√†i Kho·∫£n
                    </span>
                    <span class="badge">{{ users|length }} k·∫øt qu·∫£</span>
                </div>

                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Th√¥ng tin th√†nh vi√™n</th>
                                <th>Vai tr√≤</th>
                                <th>Ho·∫°t ƒë·ªông</th>
                                <th style="text-align: right;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td style="color: #6b7280;">#{{ user.user_id }}</td>
                                <td>
                                    <div class="user-cell">
                                        <div class="u-avatar">{{ user.username[0]|upper }}</div>
                                        <div class="u-info">
                                            <span class="u-name">{{ user.username }}</span>
                                            <span class="u-email">{{ user.email }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if user.role == 'admin' %}
                                        <span class="role-badge role-admin">Admin</span>
                                    {% else %}
                                        <span class="role-badge role-user">Member</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div style="font-weight: 500;">{{ user.review_count }} b√†i review</div>
                                    {% if user.last_active %}
                                        <div style="font-size: 12px; color: #9ca3af;">
                                            <i class="fa-regular fa-clock"></i> {{ user.last_active }}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 12px; color: #9ca3af;">Ch∆∞a ho·∫°t ƒë·ªông</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <!-- Kh√¥ng cho ph√©p thao t√°c ch√≠nh m√¨nh (tr·ª´ xem l·ªãch s·ª≠) -->
                                        {% if user.user_id != session['id'] %}
                                            <!-- 1. Xem L·ªãch S·ª≠ -->
                                            <a href="{{ url_for('admin_view_history', user_id=user.user_id) }}" class="btn-icon btn-view" title="Xem l·ªãch s·ª≠ ho·∫°t ƒë·ªông">
                                                <i class="fa-regular fa-eye"></i>
                                            </a>

                                            <!-- 2. ƒê·ªïi Quy·ªÅn -->
                                            <form action="{{ url_for('admin_toggle_role', user_id=user.user_id) }}" method="POST">
                                                <button type="submit" class="btn-icon btn-role" title="ƒê·ªïi quy·ªÅn Admin/Member" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën thay ƒë·ªïi quy·ªÅn c·ªßa {{ user.username }}?')">
                                                    <i class="fa-solid fa-user-shield"></i>
                                                </button>
                                            </form>

                                            <!-- 3. Reset M·∫≠t Kh·∫©u -->
                                            <form action="{{ url_for('admin_reset_pass', user_id=user.user_id) }}" method="POST">
                                                <button type="submit" class="btn-icon btn-reset" title="Reset m·∫≠t kh·∫©u v·ªÅ 123456" onclick="return confirm('Reset m·∫≠t kh·∫©u c·ªßa {{ user.username }} v·ªÅ 123456?')">
                                                    <i class="fa-solid fa-key"></i>
                                                </button>
                                            </form>

                                            <!-- 4. X√≥a User -->
                                            <form action="{{ url_for('admin_delete_user', user_id=user.user_id) }}" method="POST">
                                                <button type="submit" class="btn-icon btn-delete" title="X√≥a t√†i kho·∫£n vƒ©nh vi·ªÖn" onclick="return confirm('C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn {{ user.username }} v√† to√†n b·ªô d·ªØ li·ªáu!')">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </form>
                                        {% else %}
                                            <span style="font-size: 13px; color: #9ca3af; font-style: italic; padding-right: 10px;">(T√†i kho·∫£n c·ªßa b·∫°n)</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5">
                                    <div class="empty-search">
                                        <i class="fa-solid fa-magnifying-glass-minus"></i>
                                        <p>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o ph√π h·ª£p v·ªõi t·ª´ kh√≥a "{{ search_query }}"</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification Container -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div id="toast-container">
            {% for category, message in messages %}
                <div class="toast toast-{{ category }}">
                    {% if category == 'success' %}
                        <i class="fa-solid fa-circle-check"></i>
                    {% elif category == 'error' %}
                        <i class="fa-solid fa-circle-exclamation"></i>
                    {% else %}
                        <i class="fa-solid fa-circle-info"></i>
                    {% endif %}
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        </div>

        <!-- Auto hide toast after 3.5s -->
        <script>
            setTimeout(() => {
                const toasts = document.getElementById('toast-container');
                if (toasts) {
                    toasts.style.transition = 'opacity 0.5s ease';
                    toasts.style.opacity = '0';
                    setTimeout(() => toasts.remove(), 500);
                }
            }, 3500);
        </script>
      {% endif %}
    {% endwith %}
</body>
</html>